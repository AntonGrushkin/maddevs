name: Staging
on:
  pull_request:
  push:
    branches:
      - AD-3889

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build and push Docker images
        uses: docker/build-push-action@v1
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          dockerfile: Dockerfile
          repository: maddevsio/maddevsio
          tags: staging

      - name: Deploy via SSH
        uses: fifsky/ssh-action@master
        with:
          command: |
            docker rm -f maddevsio || true
            docker run -d --name=maddevsio --restart=always -e NODE_JEST_COVERAGE_SLACK_WEBHOOK_URL=${{secrets.NODE_JEST_COVERAGE_SLACK_WEBHOOK_URL}} -e NODE_SENDPULSE_API_USER_ID=${{secrets.NODE_SENDPULSE_API_USER_ID}} -e NODE_SENDPULSE_API_KEY=${{secrets.NODE_SENDPULSE_API_KEY}} -e NODE_API_URL=${{secrets.NODE_API_URL}} -e VIRTUAL_HOST=${{secrets.DOMAIN}} -e LETSENCRYPT_HOST=${{secrets.DOMAIN}} -e LETSENCRYPT_EMAIL=${{secrets.EMAIL}} maddevsio/maddevsio:staging
          host: ${{ secrets.HOST }}
          user: github
          key: ${{ secrets.PRIVATE_KEY}}

